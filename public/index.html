<html>
<head>
  <title>livepoll</title>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="/socket.io/socket.io.js"> </script>
  <script>
    var packAmount = 1000;
    function packPosition(x) {return Math.floor(x * packAmount);}
    function unpackPosition(x) {return x / packAmount;}
    function clamp(x, min, max) {return x < min ? min : (x > max ? max : x);}
    function map(x, minin, maxin, minout, maxout) {return (maxout - minout) * (x - minin) / (maxin - minin) + minout;}

    var w, h;
    $(document).ready(function() {
      w = $(document).width();
      h = $(document).height();
    });
    $(window).resize(function() {
      w = $(document).width();
      h = $(document).height();
    });
    var socket = io.connect();
    var updateReady = true;
    $(document).mousemove(function(event) {
      if(updateReady) {
        socket.emit('m', {
          x: packPosition(event.pageX / w),
          y: packPosition(event.pageY / h)
        });
        updateReady = false;
      }
    });
    setInterval(function() {updateReady = true}, 100); // min time between sending mouse movement
    socket.on('mc', function (mouseCollection) {
      var cursors = $("#cursors");
      var avg = 0, count = 0;
      for(var id in mouseCollection) {
        var mouse = mouseCollection[id];
        var x = unpackPosition(mouse.x);
        var y = unpackPosition(mouse.y);
        avg += clamp(x, .2, .8);
        count++;
        if(id != socket.id) { // don't show myself
          if(!$("#" + id).length) {
            // add new cursors
            cursors.append('<img src="cursor.png" id="' + id + '" style="position:absolute;"/>')
          }
          // update cursors
          $("#" + id).offset({left: x * w, top: y * h});
        }
      }
      avg /= count;
      $("#percentage").text(Math.floor(map(avg, .2, .8, 100, 0)) + "%");
      // remove disconnected cursors
      $("#cursors").children().each(function() {
        if(!(this.id in mouseCollection)) {
          this.remove();
        }
      });
    });
    socket.on('id', function (id) {
      socket.id = id;
    });
  </script>
  <style>
  body {
    overflow:hidden;
    font-family: sans-serif;
    font-size: 4em;
  }
  .unselectable {
    cursor:default;
     -moz-user-select: -moz-none;
     -khtml-user-select: none;
     -webkit-user-select: none;
     -ms-user-select: none;
     user-select: none;
   }
  .center {
    left: 0;
    position: absolute;
    text-align: center;
    top: 50%;
    width: 100%;
  }
  .offset {
    line-height: 1em;
    margin-top: -.5em;
  }
  </style>
</head>
<body class="unselectable">
  <h1 class="center offset" id="percentage">50%</h1>
  <div class="center"><h1 id="minus" class="offset" style="margin-left: 10%; margin-right: 90%;">+</h1></div>
  <div class="center"><h1 id="plus" class="offset" style="margin-left: 80%; margin-right: 20%;">-</h1></div>
  <div id="cursors"></div>
</body>
</html>